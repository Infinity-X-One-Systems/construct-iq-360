name: Genesis PR Management - Auto-squash, Merge and Close

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run — log actions without executing them'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  schedule:
    # Run once daily at 07:00 UTC after CI settles overnight
    - cron: '0 7 * * *'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ─────────────────────────────────────────────────────────────────
  # JOB 1: Close outdated PRs and delete their branches
  # ─────────────────────────────────────────────────────────────────
  close-outdated-prs:
    name: Close Outdated PRs
    runs-on: ubuntu-latest
    steps:
      - name: Close superseded PRs
        uses: actions/github-script@v7
        with:
          script: |
            const DRY_RUN = '${{ github.event.inputs.dry_run }}' === 'true';
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // PRs superseded by PR #16 (the master branch that contains the full system)
            const OUTDATED_PRS = [
              { number: 3,  reason: 'WIP Hunter / Command Center — superseded by the full system implementation in PR #16.' },
              { number: 5,  reason: 'Autonomous workflow additions — core workflows are already present in main; all improvements are included in PR #16.' },
              { number: 7,  reason: 'genesis-loop dependency fix — the fix is already incorporated in the current main branch and in PR #16.' },
              { number: 10, reason: 'E2E system / Command Center deployment — consolidated and superseded by the comprehensive PR #16.' },
              { number: 11, reason: 'infinity-core container UTF-8 fix — Docker-host-local fix that targets an outdated base SHA; not required for system operation on GitHub Pages.' },
              { number: 14, reason: 'GitHub Pages configure-pages fix — superseded by the full deploy-command-center overhaul in PR #16.' },
              { number: 15, reason: 'YAML syntax, datetime and Pages fixes — all changes are included in PR #16 which provides the complete system.' },
            ];

            const CLOSING_COMMENT = (reason) => [
              '## Genesis PR Management — Closing: Superseded',
              '',
              'Overseer-Prime has analysed all open pull requests and determined this PR is no longer needed.',
              '',
              '### Reason',
              reason,
              '',
              '### Master PR',
              'All relevant changes have been consolidated into PR #16 — "Wire ChatGPT + Copilot to Infinity Orchestrator GitHub App with full Shadow agent system-control", which contains the complete, up-to-date implementation of the Construct-IQ-360 system.',
              '',
              '### Action',
              '- This PR has been closed automatically.',
              '- The branch has been deleted to keep the repository clean.',
              '- No code has been lost — everything is in PR #16.',
              '',
              '---',
              'Executed by Genesis PR Management workflow | Ouroboros Protocol | Overseer-Prime',
            ].join('\n');

            for (const { number, reason } of OUTDATED_PRS) {
              try {
                const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: number });

                if (pr.state !== 'open') {
                  console.log(`PR #${number} already ${pr.state} — skipping`);
                  continue;
                }

                console.log(`${DRY_RUN ? '[DRY RUN] ' : ''}Closing PR #${number}: ${pr.title}`);

                if (!DRY_RUN) {
                  // Post closing comment
                  await github.rest.issues.createComment({
                    owner, repo,
                    issue_number: number,
                    body: CLOSING_COMMENT(reason),
                  });

                  // Close the PR
                  await github.rest.pulls.update({
                    owner, repo,
                    pull_number: number,
                    state: 'closed',
                  });

                  // Delete the branch (best-effort)
                  try {
                    await github.rest.git.deleteRef({
                      owner, repo,
                      ref: `heads/${pr.head.ref}`,
                    });
                    console.log(`  Deleted branch: ${pr.head.ref}`);
                  } catch (branchErr) {
                    console.log(`  Branch ${pr.head.ref} already deleted or protected: ${branchErr.message}`);
                  }
                }
              } catch (err) {
                // PR may not exist — skip gracefully
                console.log(`PR #${number} not found or already processed: ${err.message}`);
              }
            }

            console.log(`${DRY_RUN ? '[DRY RUN] ' : ''}Outdated PR cleanup complete.`);

  # ─────────────────────────────────────────────────────────────────
  # JOB 2: Promote PR #16 from draft to ready-for-review
  # This unblocks the existing auto-merge.yml which skips drafts
  # ─────────────────────────────────────────────────────────────────
  promote-master-pr:
    name: Promote PR 16 to Ready for Review
    runs-on: ubuntu-latest
    needs: close-outdated-prs
    steps:
      - name: Convert draft to ready and request review
        uses: actions/github-script@v7
        with:
          script: |
            const DRY_RUN = '${{ github.event.inputs.dry_run }}' === 'true';
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const MASTER_PR = 16;

            const { data: pr } = await github.rest.pulls.get({
              owner, repo,
              pull_number: MASTER_PR,
            });

            console.log(`PR #${MASTER_PR} state=${pr.state} draft=${pr.draft} mergeable_state=${pr.mergeable_state}`);

            if (pr.state !== 'open') {
              console.log(`PR #${MASTER_PR} is not open (${pr.state}) — nothing to do.`);
              return;
            }

            if (!pr.draft) {
              console.log(`PR #${MASTER_PR} is already ready for review.`);
            } else {
              console.log(`${DRY_RUN ? '[DRY RUN] ' : ''}Promoting PR #${MASTER_PR} from draft to ready for review...`);

              if (!DRY_RUN) {
                await github.rest.pulls.update({
                  owner, repo,
                  pull_number: MASTER_PR,
                  draft: false,
                });

                await github.rest.issues.createComment({
                  owner, repo,
                  issue_number: MASTER_PR,
                  body: [
                    `## Genesis PR Management — PR #${MASTER_PR} Promoted to Ready for Review`,
                    '',
                    'Overseer-Prime has completed the following genesis operations:',
                    '',
                    '### Closed (Superseded)',
                    '- PR #3  — WIP Hunter / Command Center',
                    '- PR #5  — Autonomous workflow additions',
                    '- PR #7  — genesis-loop dependency fix',
                    '- PR #10 — E2E system / Command Center deployment',
                    '- PR #11 — infinity-core container UTF-8 fix',
                    '- PR #14 — GitHub Pages configure-pages fix',
                    '- PR #15 — YAML syntax, datetime and Pages fixes',
                    '',
                    '### Status',
                    `This PR (#${MASTER_PR}) contains the complete Construct-IQ-360 system and is now ready for review and auto-merge.`,
                    '',
                    'The auto-merge.yml workflow will execute a squash merge once all CI checks pass.',
                    '',
                    '---',
                    'Genesis PR Management | Ouroboros Protocol | Overseer-Prime',
                  ].join('\n'),
                });

                console.log(`PR #${MASTER_PR} promoted successfully.`);
              }
            }

  # ─────────────────────────────────────────────────────────────────
  # JOB 3: Create GitHub Project v2 board with system learning templates
  # ─────────────────────────────────────────────────────────────────
  setup-project-board:
    name: Create System Project Board
    runs-on: ubuntu-latest
    needs: close-outdated-prs
    steps:
      - name: Create GitHub Project board via GraphQL
        uses: actions/github-script@v7
        with:
          script: |
            const DRY_RUN = '${{ github.event.inputs.dry_run }}' === 'true';
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            if (DRY_RUN) {
              console.log('[DRY RUN] Would create GitHub Project board');
              return;
            }

            // Resolve the organization node ID
            let ownerId;
            try {
              const orgResult = await github.graphql(`
                query($login: String!) {
                  organization(login: $login) { id }
                }`, { login: owner });
              ownerId = orgResult.organization.id;
            } catch {
              // Fallback to user context if not an org
              const userResult = await github.graphql(`
                query($login: String!) {
                  user(login: $login) { id }
                }`, { login: owner });
              ownerId = userResult.user.id;
            }

            // Create the Project v2 board
            let projectId, projectNumber, projectUrl;
            try {
              const createResult = await github.graphql(`
                mutation($ownerId: ID!, $title: String!) {
                  createProjectV2(input: { ownerId: $ownerId, title: $title }) {
                    projectV2 { id number url }
                  }
                }`, {
                ownerId,
                title: 'Construct-IQ-360 System Board',
              });
              projectId     = createResult.createProjectV2.projectV2.id;
              projectNumber = createResult.createProjectV2.projectV2.number;
              projectUrl    = createResult.createProjectV2.projectV2.url;
              console.log(`Created project #${projectNumber}: ${projectUrl}`);
            } catch (err) {
              console.log(`Project may already exist or could not be created: ${err.message}`);
              return;
            }

            // Add a text field: "Module"
            await github.graphql(`
              mutation($projectId: ID!, $name: String!, $dataType: ProjectV2CustomFieldType!) {
                addProjectV2Field(input: { projectId: $projectId, name: $name, dataType: $dataType }) {
                  field { ... on ProjectV2Field { id } }
                }
              }`, {
              projectId,
              name: 'Module',
              dataType: 'TEXT',
            });

            // Learning items — system guide as project cards
            const LEARNING_ITEMS = [
              { title: 'QUICK START: Log in with your GitHub PAT', module: 'Auth', body: 'Go to the Command Center login page. Enter your GitHub Personal Access Token (PAT) with repo + workflow read access. Your token is stored in localStorage — never sent to a server.' },
              { title: 'MODULE 1: CRM — Manage construction leads', module: 'CRM', body: 'Navigate to CRM / Leads. View, sort and filter leads by status, value and owner. Export to CSV (Google Sheets compatible). Statuses: New → Qualified → Proposal → Won / Lost.' },
              { title: 'MODULE 2: Templates — Build proposals and bids', module: 'Templates', body: 'Choose from 11 construction templates (residential bid, commercial bid, TI bid, change order, subcontractor agreement, lien waivers, checklists, runbooks). Fill variable form and generate a complete document.' },
              { title: 'MODULE 3: Billing — Invoices and calculators', module: 'Billing', body: 'Create and manage invoices. Built-in retainage calculator (10% → 50% completion, then 5%). Tax calculator. Export to CSV for Google Sheets / QuickBooks import. AIA G702/G703 compatible.' },
              { title: 'MODULE 4: Documents — Blueprints and runbooks', module: 'Documents', body: 'Browse the full document library: blueprints, checklists (9 construction phases), runbooks, roadmaps, contract templates. Search and filter by category. Download as Markdown.' },
              { title: 'MODULE 5: Agents — Biz-Ops autonomous team', module: 'Agents', body: 'Six agents: Hunter (leads), Architect (estimation + Vertex AI), Orator (documents), Shadow (headless browser), Commander (deployment + Genesis Loop), Vault (enterprise memory + rehydration). Each has a JSON blueprint in apps/biz-ops/blueprints/.' },
              { title: 'MODULE 6: AI Hub — Connect ChatGPT and Copilot', module: 'AI Hub', body: 'ChatGPT: Add the Custom GPT action using public/openapi.yaml. Copilot Mobile: point to .github/copilot-instructions.md. All commands route through Infinity-X-One-Systems/infinity-orchestrator (autonomous-invention.yml). Auth: Fine-Grained PAT with Actions:R/W.' },
              { title: 'MODULE 7: Shadow Agent — Headless browser automation', module: 'Shadow', body: 'Shadow agent runs Playwright + BeautifulSoup for permit scraping, form-fill, and snapshots. Governed by guardrails: rate-limit 2 req/s, no auth bypass, no PII storage. Dispatch via AI Hub → Shadow tab or via orchestrator goal.' },
              { title: 'MODULE 8: Orchestrator — System-wide control', module: 'Orchestrator', body: 'Send natural-language goals to Infinity Orchestrator (autonomous-invention.yml). TAP Protocol validates → repository_dispatch → dispatch-bridge.yml → agent runner. Use systemControl operation for structured shadow + agent commands.' },
              { title: 'MODULE 9: Google Workspace Pipeline', module: 'Workspace', body: 'Export CRM leads and invoices as CSV. Import into Google Sheets using the column schemas in docs/GOOGLE_WORKSPACE_PIPELINE.md. Apps Script snippets provided for auto-formatting, index sheet, and cross-tab calculators.' },
              { title: 'MODULE 10: Docker + Terraform — Infrastructure', module: 'Infra', body: 'docker-compose.yml: 5 services (command-center:3000, shadow-api:8080, biz-ops, vault:8090, redis) on infinity-mesh network. Terraform at infra/terraform/main.tf: GCP Vertex AI, AutoML, Cloud Run. See docs/RUNBOOKS.md for deployment runbook.' },
              { title: 'SETUP: Enable GitHub Pages for Command Center', module: 'Deploy', body: 'Go to Settings → Pages → Source: GitHub Actions. The deploy-command-center.yml workflow builds the Next.js app (static export) and deploys to https://infinityxonesystems.github.io/construct-iq-360/' },
              { title: 'SETUP: Configure secrets for autonomous workflows', module: 'Secrets', body: 'Add secrets in Settings → Secrets: GOOGLE_MAPS_API_KEY (Hunter agent), OPENAI_API_KEY (AI Hub chat), VERTEX_AI_KEY (Architect Vertex AI). See docs/AI_CONNECTORS.md for the full list.' },
              { title: 'WORKFLOW: How auto-merge works (Ouroboros Protocol)', module: 'Workflow', body: 'Copilot creates PRs → pr-orchestrator.yml converts drafts to ready → auto-merge.yml squash-merges on CI pass → branch is deleted. No human intervention needed. genesis-loop.yml self-optimizes every 6 hours.' },
            ];

            // Add each item to the project
            for (const item of LEARNING_ITEMS) {
              try {
                await github.graphql(`
                  mutation($projectId: ID!, $title: String!) {
                    addProjectV2DraftIssue(input: { projectId: $projectId, title: $title }) {
                      projectItem { id }
                    }
                  }`, {
                  projectId,
                  title: item.title,
                });
                console.log(`Added: ${item.title}`);
              } catch (err) {
                console.log(`Could not add item "${item.title}": ${err.message}`);
              }
            }

            // Write project URL to summary
            core.summary
              .addHeading('Genesis Project Board Created')
              .addRaw(`Project URL: ${projectUrl}`)
              .addBreak()
              .addRaw(`Added ${LEARNING_ITEMS.length} learning modules as project items.`)
              .write();

            console.log(`\nProject board setup complete: ${projectUrl}`);

  # ─────────────────────────────────────────────────────────────────
  # JOB 4: Validate system after all operations
  # ─────────────────────────────────────────────────────────────────
  validate-system:
    name: Validate System State
    runs-on: ubuntu-latest
    needs: [close-outdated-prs, promote-master-pr, setup-project-board]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install PyYAML
          if [ -f apps/hunter-agent/requirements.txt ]; then
            pip install -r apps/hunter-agent/requirements.txt || true
          fi

      - name: Run system validation
        run: |
          if [ -f .github/scripts/validate-system.py ]; then
            python3 .github/scripts/validate-system.py
          else
            echo "Validation script not found — running basic checks"
            echo "Checking core directories..."
            for d in apps/hunter-agent apps/architect-ai apps/biz-ops apps/command-center; do
              [ -d "$d" ] && echo "  OK: $d" || echo "  MISSING: $d"
            done
            echo "Checking key workflows..."
            for f in .github/workflows/genesis-loop.yml .github/workflows/auto-merge.yml .github/workflows/dispatch-bridge.yml; do
              [ -f "$f" ] && echo "  OK: $f" || echo "  MISSING: $f"
            done
            echo "Basic validation complete."
          fi

      - name: Validate PR #16 status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: 16,
            });
            console.log(`PR #16 — state: ${pr.state}, draft: ${pr.draft}, mergeable_state: ${pr.mergeable_state}`);
            const ready = pr.state === 'open' && !pr.draft;
            core.setOutput('pr16_ready', ready ? 'true' : 'false');
            if (ready) {
              console.log('PR #16 is open and ready for auto-merge.');
            } else {
              console.log('PR #16 still in draft — auto-merge will be triggered by pr-orchestrator.yml on next scheduled run.');
            }

      - name: Write summary
        run: |
          echo "## Genesis PR Management — Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Close outdated PRs (#3,5,7,10,11,14,15) | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| Promote PR #16 to ready-for-review | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| Create System Project Board | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| System validation | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** auto-merge.yml will squash-merge PR #16 once all CI checks pass." >> $GITHUB_STEP_SUMMARY
