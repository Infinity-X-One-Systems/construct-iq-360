name: ğŸ§ª E2E System Test

on:
  workflow_dispatch:
  schedule:
    # Run daily at 09:00 UTC to validate system health
    - cron: '0 9 * * *'

permissions:
  contents: read
  issues: write

jobs:
  e2e-test:
    name: ğŸ§ª End-to-End System Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing Hunter Agent dependencies..."
          pip install -r apps/hunter-agent/requirements.txt
          
          echo "ğŸ“¦ Installing Architect AI dependencies..."
          if [ -f "apps/architect-ai/requirements.txt" ]; then
            pip install -r apps/architect-ai/requirements.txt
          fi
      
      - name: ğŸ§ª Run System Validation
        run: |
          python3 .github/scripts/validate-system.py
      
      - name: ğŸ¯ Test Hunter Agent
        run: |
          echo "ğŸ¯ Testing Hunter Agent execution..."
          cd apps/hunter-agent
          python3 main.py
          echo "âœ… Hunter Agent test complete"
      
      - name: ğŸ“ Test Architect AI
        run: |
          echo "ğŸ“ Testing Architect AI..."
          python3 -c "
          import sys
          sys.path.append('apps/architect-ai')
          from estimator import ConstructionEstimator
          print('âœ… Architect AI import successful')
          "
      
      - name: ğŸ“Š Validate Data Layer
        run: |
          echo "ğŸ“Š Validating data layer..."
          
          # Check leads.json
          if [ -f "data/leads.json" ]; then
            python3 -c "import json; json.load(open('data/leads.json'))"
            echo "âœ… leads.json is valid"
          else
            echo "âŒ leads.json missing"
            exit 1
          fi
          
          # Check active memory
          if [ -f ".infinity/ACTIVE_MEMORY.md" ]; then
            echo "âœ… ACTIVE_MEMORY.md exists"
          else
            echo "âŒ ACTIVE_MEMORY.md missing"
            exit 1
          fi
      
      - name: ğŸ”„ Validate Workflows
        run: |
          echo "ğŸ”„ Validating workflow files..."
          
          workflows=(
            "auto-merge.yml"
            "genesis-loop.yml"
            "heartbeat.yml"
            "hunter-cron.yml"
            "self-repair.yml"
            "pr-orchestrator.yml"
            "conflict-resolver.yml"
          )
          
          for workflow in "${workflows[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              echo "âœ… $workflow exists"
            else
              echo "âŒ $workflow missing"
              exit 1
            fi
          done
      
      - name: ğŸ“ˆ Generate Report
        if: always()
        run: |
          echo "ğŸ“ˆ E2E TEST REPORT"
          echo "=================="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Test Status: ${{ job.status }}"
          echo ""
          echo "âœ… All E2E tests completed"
